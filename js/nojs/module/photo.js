/*Thu Nov 14 2013 11:05:11 GMT+0800 (中国标准时间)-http://nolure.github.io/nojs.docs*/define("nojs/module/photo",["nojs/module/fullscreen"],function(require,a,b){function c(){var a=[],b=null,c=function(){for(var b=0;b<a.length;b++)a[b].end?a.splice(b--,1):a[b]();!a.length&&d()},d=function(){clearInterval(b),b=null};return function(d,e,f,g){var h,i,j,k,l,m=new Image;return m.src=d,m.complete?(e.call(m),f&&f.call(m),void 0):(i=m.width,j=m.height,m.onerror=function(){g&&g.call(m),h.end=!0,m=m.onload=m.onerror=null},h=function(){k=m.width,l=m.height,(k!==i||l!==j||k*l>1024)&&(e.call(m),h.end=!0)},h(),m.onload=function(){!h.end&&h(),f&&f.call(m),m=m.onload=m.onerror=null},h.end||(a.push(h),null===b&&(b=setInterval(c,40))),void 0)}}function d(b,c){this.box="string"==typeof b?a("#"+b):b,this.options=c=c||{},this.item=this.box.find(".pic_list .list").children(),this.length=this.item.length,this.wrap=c.wrap||this.box,this.full=null,this.index=c.index||0,this.type=c.type,this.init()}function e(c,d){d=d||{},d.type="lightbox",d.wrap=a('<div class="lightbox_wrap"><div class="content"><div class="img"></div><i class="loading"></i><i class="p prev"></i><i class="p next"></i><i class="close"></i></div><div class="info"></div></div>').appendTo(a("body")),this.layer=b.layer,this.align=new b.align({nearby:window,element:d.wrap}),this.fullScreen=d.fullScreen,e.baseConstructor.call(this,c,d)}var f=require("nojs/module/fullscreen");return d.prototype={init:function(){this.content=this.wrap.children(".content"),this.info=this.wrap.children(".info"),this.img=this.wrap.find(".img"),this.close=this.wrap.find(".close"),this.loading=this.wrap.find(".loading"),this.ready=c(),this.image=a('<img src="" />'),this.bind()},bind:function(){for(var b,c=this,d=0,b=0;b<this.length;b++)d+=this.item.eq(b).outerWidth(!0);this.info.find(".pic_list .list").width(d),this.number=this.wrap.find(".num"),this.number.find("i").text(this.length),this.page=this.wrap.find("i.p").css({opacity:"0.4"}),this.createPageIco(this.page),this.page.click(function(b){b.preventDefault(),c.load(a(this).hasClass("prev")?--c.index:++c.index)}).hover(function(){a(this).is(":visible")&&a(this).stop().fadeTo(200,1)},function(){a(this).is(":visible")&&a(this).stop().fadeTo(200,.2)}),this.wrap.click(function(b){var d,f,g,h,i=b.target,j=i.tagName.toLowerCase();if("a"==j){if(f=a(i),d=f.attr("data-action"),"full"==d){if(!c.full){var k=a.extend({},c.options);k.onChange=function(a){c.load(a)},c.full=new e(c.box,k)}c.full.show(c.index)}else"full_screen"==d?(g=a(window).height(),h||(h=c.content.height()/g),c.fullScreen=c.fullScreen?null:!0,c.content.animate({height:c.fullScreen?g:g*h},200,function(){c.fullScreen?c.content.height("100%"):c.content.removeAttr("style"),c.load(c.index,!0)}),c.close.hide(),f.text(c.fullScreen?"退出全屏":"全屏")):"close"==d&&c.hide();return!1}}),this.item.each(function(b){var d=a(this);!function(a){d.click(function(){return c.load(a),!1})}(b)}),"lightbox"!=this.type&&this.load(this.index)},createPageIco:function(c){function d(b){var c,d=this.width,e=this.height,f=this.ctx;this.hasCanvas?(f.lineWidth=7,f.strokeStyle="#000"):(this.canvas=a("<i></i>"),this.ico.append(this.canvas),this.color="#BABABA"),c="prev"==b?[.8*d,0,.1*d,.5*e,.8*d,e]:[.2*d,0,.9*d,.5*e,.2*d,e],this.drawLine(c,!1,3),this.hasCanvas?(f.lineWidth=5,f.strokeStyle="rgba(255,255,255,0.7)"):this.color="#000000",this.drawLine(c,!1,4)}b.ico.prototype.Drawprev=function(){d.call(this,"prev")},b.ico.prototype.Drawnext=function(){d.call(this,"next")};var e={type:"prev",width:50,height:110,color:"#000000",bgcolor:"#cccccc"};new b.ico(c.eq(0),e),e.type="next",new b.ico(c.eq(1),e),e.width=18,e.height=36,new b.ico(c.eq(3),e),e.type="prev",new b.ico(c.eq(2),e),new b.ico(this.loading,{type:"loading",color:"#006CFF",width:48,height:48}),new b.ico(this.close,{type:"close",bgcolor:"#999",color:"#000",width:32,height:32})},srcRule:function(a,b){return this.options.srcRule?this.options.srcRule(a,b):a},load:function(b,c){if(b=b>this.length-1?0:b,b=0>b?this.length-1:b,c)return this.setCenter(this.image[0]),void 0;var d,e,f=this,g=a(this.item[b]);if(g.length&&("img"==g[0].tagName.toLowerCase()||(g=g.find("img"),g.length))){this.img.find("img").length||(this.img.show(),this.img.append(this.image)),d=g.attr("src");var e=this.info.find(".wrap img");this.info.find(".wrap").stop().animate({scrollLeft:e.outerWidth()*(b-2)},200),this.number.find("em").text(b+1),this.wrap.find(".title").html(g.attr("data-title")||""),this.wrap.find(".desc").html(g.attr("data-desc")||""),d=this.srcRule(d,g),this.image.attr("src",d).hide(),this.loading.show(),this.ready(d,function(){f.image.data("size",{width:this.width,height:this.height}),f.setCenter(this)},function(){f.loading.hide(),setTimeout(function(){f.image.show()},100)},function(){f.close.show(),f.loading.hide()}),this.index=b,this.page.show(),0==b&&this.page.eq(0).hide(),b==this.item.length-1&&this.page.eq(1).hide(),this.options.onChange&&this.options.onChange(b),this.info.find(".pic_list img").eq(b).addClass("current").siblings().removeClass("current")}},setCenter:function(a){var b=this,c=this.image.data("size"),d=c?c.width:a.width,e=c?c.height:a.height,f=2*(parseInt(this.img.css("padding-left"),10)||0),g=this.limit({width:d+f,height:e+f}),h=200;d=g.width,e=g.height,this.img.animate({"margin-left":-d/2,"margin-top":-e/2,width:d-f,height:e-f},h,function(){b.close.show()}),d-=f,e-=f,this.image.animate({"margin-left":-d/2,"margin-top":-e/2,width:d,height:e},h),this.close.css({left:this.content.width()/2+d/2+f/2,top:this.content.height()/2-e/2-f/2,display:"none",margin:"-16px 0 0 -16px"})},limit:function(a){var b=a.width,c=a.height,d=this.content.width(),e=this.content.height(),f=b/c,g=d/e;return f>g&&b>d?(b=d,c=b/f):g>=f&&c>e&&(c=e,b=c*f),{width:b,height:c}}},b.extend(e,d),b.extend.proto(e,{bind:function(b){var c,d=this,e=this.info.append(['<div class="pic_list">','<i class="p prev" data-action="scroll"></i>','<i class="p next" data-action="scroll"></i>','<div class="wrap"><div class="list"></div></div>',"</div>",'<div class="txt">','<div class="num"><em></em> / <i></i></div>','<div class="title"></div>','<div class="desc"></div>',"</div>"].join("")).find(".pic_list .list");a.each(this.item,function(b,c){var d="img"==c.tagName.toLowerCase()?a(c):a(c).find("img");d.length&&(d=d.clone().attr({style:""}),e.append(d))}),this.item=e.find("img"),this.close.click(function(){d.hide()}),a(window).resize(function(){clearTimeout(c),d.close.hide(),c=setTimeout(function(){d.load(d.index,!0)},300)}),this.wrap[0].addEventListener(f.fullScreenEventName,function(){!f.isFullScreen()&&d.hide()},!0),b.call(this)}}),e.prototype.show=function(b){f.requestFullScreen(this.wrap[0]),a("html").addClass("lightbox"),this.align.set(),this.wrap.fadeIn(300),this.layer.show(.95),"function"==typeof this.options.onShow&&this.options.onShow.call(this),this.load(b),this.fullScreen&&(this.fullScreen=null,this.info.find("a[data-action=full_screen]").click())},e.prototype.hide=function(){f.cancelFullScreen(this.wrap[0]),a("html").removeClass("lightbox"),this.wrap.hide(),this.layer.hide(),"function"==typeof this.options.onHide&&this.options.onHide.call(this)},{player:d,lightbox:e}}),define("nojs/module/fullscreen",[],function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.cancelFullScreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;d>c;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}return a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return""===this.prefix?a.requestFullScreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(){return""===this.prefix?document.cancelFullScreen():document[this.prefix+"CancelFullScreen"]()}),a});