/*nolure@vip.qq.com|http://nolure.github.io/nojs.docs*/define("nojs/module/tree",[],function(require,a){function b(c,d){if(+new Date,this.box="string"==typeof c?a("#"+c):c,this.options=d||{},this._data=d.data,this.ajaxMode="string"==typeof this._data,this.data=this.ajaxMode?null:b.format(this._data),this.box.length&&(this.ajaxMode||this.data))if(this.ajaxMode){var e=this;b.ajax({url:this._data,tree:this,success:function(){e.init(null,!0)}})}else this.init(null,!0)}return b.key={},b.max=100,b.rootID=-1,b.ajax=function(c){c=c||{},a.getJSON(c.url,c.data,function(a){if(1==a.status){var d=c.tree;d&&a.data&&(d.data=b.format(a.data,d.data)),c.success&&c.success(a.data)}})},b.format=function(c,d){function e(a,c,d){var l,m,n,o,p,q=a.length,r=0;for(j++,l=0;q>l;l++)if(n=a[l],o=n[g.id],r++,void 0!=o&&!k[o]){if(k[o]=n,p=n[g.parent],void 0==p){k[o]={level:c};for(m in n)k[o][m]=m==f?[]:n[m];k[o][f]=k[o][f]||[],c>0&&(k[o][g.parent]=d,k[d][f].push(o)),n[f]&&n[f].length&&e(n[f],c+1,o)}else if(p==b.rootID)n.level=c=0,n[f]=[];else{if(n[f]=[],!k[p]){delete k[o],r--;continue}k[p][f]=k[p][f]||[],k[p][f].push(o),n.level=c=k[p].level+1}i[c]=i[c]||[],i[c].push(k[o])}2==h&&q>r&&3>j&&e(a)}var f,g,h=a.type(c),i=d&&d.level?d.level:[],j=0,k=d&&d.all?d.all:{};return b.key=g=a.extend({id:"id",name:"name",parent:"parent",children:"children",open:"open",link:"link"},b.key),f=g.children,"array"==h&&c.length&&"object"==a.type(c[0])?(h=void 0==c[0][g.parent]?1:2,e(c,0),{all:k,level:i}):{all:k,level:i}},b.parents=function(a,c,d){var e,f=b.key.parent,g=b.key.id,h=[];if(c=c||{},a=c[a],!a)return h;for(e=a[f];(e=c[e])&&(!d||!d(e));e=e[f])h.push(e[g]);return h},b.prototype={init:function(c,d){var e,f,g,h,i,j,k,l,m=this,n=b.key.link,o=b.key.id,p=b.key.open,q=b.key.name,r=(b.key.parent,b.key.children),s=void 0!=c&&c!=b.rootID,t=this.data.all,u=s?t[c].level+1:0,v=s?t[c][r]:this.data.level[u],w=this.options.isCheck,x="";if(v.length){for(v["break"]=v["break"]||0,e=v["break"];e<v.length;e++){if(e>=b.max+v["break"]){v["break"]+=b.max,x+='<li class="more"><a href="" pid="'+(s?c:b.rootID)+'" data-action="more" style="margin-left:'+15*u+'px">more</a></li>';break}if(g=v[e],g=s?t[g]:g,j=g[o],x+='<li level="'+u+'">',i="",u)for(f=0;u>f;f++)i+='<i class="line"></i>';h=g[n]?g[n]:"",k="undefined"!=typeof g[p]?'open="'+g[p]+'"':"",l=w?'<input type="checkbox" value="'+j+'" />':"",x+='<a class="item" href="'+h+'" reallink="'+h+'" id="'+j+'" '+k+">"+i+'<i class="ico"></i>'+l+'<i class="folder"></i><span class="text">'+g[q]+"</span></a>",g[r].length?(1==g[p]||m.options.openAll?(x+='<ul data-init="true">',x+=this.init(j,!1),g.init=!0):x+="<ul>",x+="</ul>"):this.ajaxMode&&(x+="<ul></ul>"),x+="</li>"}if(d){var y,z=this.box;s?(z=a(x),y=this.box.find("#"+c),y.next("ul").data("init",!0).append(z),this.addClass(y.parent())):(this.rootWrap||(this.rootWrap=a("<ul></ul>"),z.html(this.rootWrap),this.bind()),this.rootWrap.append(x),this.addClass(z,!0)),this.replaceLink(z),function(a){var b=a.find("a.item").not(".no_child");m.options.openAll&&(a.find("ul ul").show(),b.addClass("open")),b.filter(function(){return"0"==this.getAttribute("open")}).removeClass("open").next("ul").hide(),b.filter(function(){return"1"==this.getAttribute("open")}).addClass("open").next("ul").show()}(z),!s&&this.select(this.options.defaultNode)}return x}},bind:function(){var c,d,e,f=this;this.box.off("click.tree").on("click.tree",function(g){if(e=g.target,c=a(e),c.hasClass("ico")&&!c.parent().hasClass("no_child"))if(c=c.parent(".item"),d=c.next("ul"),c.hasClass("open"))d&&d.is(":visible")&&d.hide(),c.removeClass("open");else{if(!d.data("init")){var h=c[0].id;f.ajaxMode?b.ajax({url:f._data,data:{id:h},tree:f,success:function(a){a&&a.length?f.init(h,!0):(c.addClass("no_child").next("ul").remove(),c.find(".last_ico1").length&&c.find(".last_ico1").addClass("last_ico").removeClass("last_ico1")),d.data("init",!0)}}):(f.init(h,!0),d.data("init",!0))}d&&d.is(":hidden")&&d.show(),c.addClass("open")}else if(c.hasClass("folder")||c.hasClass("item")||c.hasClass("text")||c.hasClass("line")||c.hasClass("ico"))c.hasClass("item")||(c=c.parent()),f.box.find("a.current").removeClass("current"),c.addClass("current"),f.options.onSelect&&f.options.onSelect.call(f,f.data.all[c[0].id]);else{if("input"==e.tagName.toLowerCase()){var i,j,k,l=c.closest("a.item").next("ul").find("input"),m=c.parents("ul");if(e.checked){l.attr("checked","checked");for(var i=0;i<m.length;i++)j=m.eq(i),j.find("input").not(":checked").length||j.prev("a.item").find("input").attr("checked","checked")}else l.attr("checked",!1),m.prev("a.item").find("input").attr("checked",!1);return k=f.box.find(":checked"),f.checked=k.length?function(){var a=[];return k.each(function(){a.push(this.value)}),a}():null,f.options.onCheck&&f.options.onCheck.call(f,e.id),!0}"a"==e.tagName.toLowerCase()&&"more"==c.attr("data-action")&&(f.init(c.attr("pid"),!0),c.parent().remove())}return!1})},addClass:function(a,b){a=a||this.box;var c,d,e,f,g,h,i,j,k=a.find("a.item"),l=k.length;for(c=0;l>c;c++)if(g=k.eq(c),b&&0==c&&g.find(".ico").addClass("first_ico"),i=g.closest("li"),g.next("ul").length)for(!i.next().length&&g.find(".ico").addClass("last_ico1"),j=i.attr("level"),d=0;d<i.find("li").length;d++)for(h=i.find("li").eq(d).find(".line"),!i.next().length&&h.eq(j).addClass("last_line"),e=g.find(".last_line"),f=0;f<e.length;f++)h.eq(e.eq(f).index()).addClass("last_line");else!this.ajaxMode&&g.addClass("no_child"),i.next().length||g.find(".ico").addClass("last_ico")},select:function(a,c){function d(){return g.addClass("current"),f.options.onSelect&&f.options.onSelect.call(f,f.data.all[a]),!1}function e(a){0>a||(j=k.eq(a),j.show().siblings("a.item").addClass("open"),e(--a))}if(a){c=c||"id";var f=this,g=this.box.find("a["+c+'="'+a+'"]').eq(0),h=(b.key.parent,[]);if(this.data.all[a]){if(!g||!g.length){h=b.parents(a,this.data.all,function(a){return a.init});for(var i=h.length-1;i>=0;i--)this.init(h[i],!0);g=this.box.find("a["+c+'="'+a+'"]').eq(0)}if(this.box.find("a.current").removeClass("current"),g.parents("ul").first().is(":visible"))return d();var j,k=g.parents("ul").not(":visible"),l=k.length;e(l-1),d()}}},replaceLink:function(b){if(a.browser("ie6 ie7")){b=b||this.box;var c=b.find("a");c.each(function(){this.href=this.getAttribute("reallink",2),this.removeAttribute("reallink")})}}},b.select=function(c,d){function e(a){var c,d,e="";d=u[a],e='<select name="">',e+=s?'<option value="'+b.rootID+'">根目录</option>':o;for(c in d)v!=d[c][x]&&(e+=h(d[c],a));return e+="</select>"}function f(a){var b,c="";if(w++,a.length)for(b in a)c+=h(q.all[a[b]],w);return w--,c}function g(a){var b="--";for(i=0;a>i;i++)b+="--";return b}function h(a,b){return'<option value="'+(void 0!=a[x]?a[x]:"")+'">'+(s?g(b):"")+a[y]+"</option>"+(s?f(a[z]):"")}function j(){p=e(w),p=a(p),void 0!=r[0]&&(p[0].value=r[0],r[0]=null),c.html(p)}function k(a,c){b.ajax({url:d.data,data:a,success:function(d){if(d&&d.length){if(a&&a.id){var e,f=b.key.parent;for(e=0;e<d.length;e++)d[e][f]=a.id}q=b.format(d,q),u=q.level,c?c():(j(),!s&&n(p))}}})}function l(b,c){var d=q.all[c],e=d[z];e.length&&(b=a(b),d.init=!0,w=d.level,e=a('<select name="">'+o+f(e)+"</select>"),void 0!=r[w+1]&&(e[0].value=r[w+1],r[w+1]=null),b.after(e),n(e))}function m(b){var c=b.value;a(b).nextAll("select").remove(),c!=v&&q.all[c]&&(t&&!q.all[c].init?k({id:c},function(){l(b,c)}):l(b,c))}function n(a){a.change(function(){m(this)}),a.val()&&m(a[0])}d=d||{};var o,p,q="string"==typeof d.data?{}:b.format(d.data),r=[].concat(d.select),s=0==d.level,t="string"==typeof d.data,u=t?[]:q.level,v=void 0!=d.empty?d.empty:"",w=0,x=b.key.id,y=b.key.name,z=b.key.children;if(c&&c.length&&u)return o='<option value="'+v+'">请选择</option>',t?k():j(),s||p&&n(p),p},b});