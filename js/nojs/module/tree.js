/*nolure@vip.qq.com|http://nolure.github.io/nojs.docs*/define("nojs/module/tree",[],function(require,a){function b(c,d){if(+new Date,this.box="string"==typeof c?a("#"+c):c,this.options=d=d||{},this._data=d.data,this.ajaxMode="string"==typeof this._data,this.data=this.ajaxMode?null:b.format(this._data),this.box.length&&(this.ajaxMode||this.data))if(this.max=d.max||b.max,this.ajaxMode){var e=this;b.ajax({url:this._data,tree:this,success:function(){e.init(null,!0,!0)}})}else this.init(null,!0,!0)}return b.key={},b.max=100,b.rootID=-1,b.ajax=function(c){c=c||{},a.getJSON(c.url,c.data,function(a){if(1==a.status){var d=c.tree;d&&a.data&&(d.data=b.format(a.data,d.data)),c.success&&c.success(a.data)}})},b.format=function(c,d){function e(a,c,d){var l,m,n,o,p,q=a.length,r=0;for(j++,l=0;q>l;l++)if(n=a[l],o=n[g.id],r++,void 0!=o&&!k[o]){if(k[o]=n,p=n[g.parent],void 0==p){k[o]={level:c};for(m in n)k[o][m]=m==f?[]:n[m];k[o][f]=k[o][f]||[],c>0?(k[o][g.parent]=d,k[d][f].push(o)):k[o][g.parent]=b.rootID,n[f]&&n[f].length&&e(n[f],c+1,o)}else if(p==b.rootID)n.level=c=0,n[f]=[];else{if(n[f]=[],!k[p]){delete k[o],r--;continue}k[p][f]=k[p][f]||[],k[p][f].push(o),n.level=c=k[p].level+1}i[c]=i[c]||[],i[c].push(k[o])}2==h&&q>r&&3>j&&e(a)}var f,g,h=a.type(c),i=d&&d.level?d.level:[],j=0,k=d&&d.all?d.all:{};return b.key=g=a.extend({id:"id",name:"name",parent:"parent",children:"children",open:"open",link:"link"},b.key),f=g.children,"array"==h&&c.length&&"object"==a.type(c[0])?(h=void 0==c[0][g.parent]?1:2,e(c,0),{all:k,level:i}):{all:k,level:i}},b.parents=function(a,c,d){var e,f=b.key.parent,g=b.key.id,h=[];if(c=c||{},a=c[a],!a)return h;for(e=a[f];(e=c[e])&&(!d||!d(e));e=e[f])h.push(e[g]);return h},b.prototype={init:function(c,d,e){var f,g,h,i,j,k,l,m,n=this,o=b.key.link,p=b.key.id,q=b.key.open,r=b.key.name,s=(b.key.parent,b.key.children),t=void 0!=c&&c!=b.rootID,u=this.data.all,v=t?u[c].level+1:0,w=t?u[c][s]:this.data.level[v],x=this.options.isCheck,y="";if(w.length){if(w["break"]=w["break"]||0,j="",v)for(g=0;v>g;g++)j+='<i class="line"></i>';for(f=w["break"];f<w.length;f++){if(f>=n.max+w["break"]){w["break"]+=n.max,y+='<li class="no_child more" level="'+v+'"><a href="" id="more_'+(t?c:b.rootID)+"_"+v+'" class="item" pid="'+(t?c:b.rootID)+'" data-action="more">'+j+'<i class="ico last_ico"></i><i class="folder"></i>more</a></li>';break}h=w[f],h=t?u[h]:h,k=h[p],h.init=1,y+='<li level="'+v+'">',i=h[o]?h[o]:"",l="undefined"!=typeof h[q]?'open="'+h[q]+'"':"",m=x?'<input type="checkbox" value="'+k+'" />':"",y+='<a class="item" href="'+i+'" reallink="'+i+'" id="'+k+'" '+l+">"+j+'<i class="ico"></i>'+m+'<i class="folder"></i><span class="text">'+h[r]+"</span></a>",h[s].length?(1==h[q]||n.options.openAll?(h.init=2,y+='<ul data-init="true">',y+=this.init(k,!1)):y+="<ul>",y+="</ul>"):this.ajaxMode&&(y+="<ul></ul>"),y+="</li>"}if(d){var z,A=this.box;t?(A=a(y),z=this.box.find("#"+c),z.next("ul").data("init",!0).append(A),this.addClass(z.parent())):(this.rootWrap||(this.rootWrap=a("<ul></ul>"),A.html(this.rootWrap),this.bind()),this.rootWrap.append(y),this.addClass(A,!0)),this.replaceLink(A),function(a){var b=a.find("a.item").not(".no_child");n.options.openAll&&(a.find("ul ul").show(),b.addClass("open")),b.filter(function(){return"0"==this.getAttribute("open")}).removeClass("open").next("ul").hide(),b.filter(function(){return"1"==this.getAttribute("open")}).addClass("open").next("ul").show()}(A),!this.selected&&e&&this.select(this.options.defaultNode)}return y}},bind:function(){var c,d,e,f,g=this;this.box.off("click.tree").on("click.tree",function(h){if(f=h.target,c=a(f),d=c.parent(),"more"==c.attr("data-action")||"more"==d.attr("data-action"))c="more"==d.attr("data-action")?d:c,g.init(c.attr("pid"),!0),c.parent().remove();else if(c.hasClass("ico")&&!c.parent().hasClass("no_child"))if(c=c.parent(".item"),e=c.next("ul"),c.hasClass("open"))e&&e.is(":visible")&&e.hide(),c.removeClass("open");else{if(!e.data("init")){var i=c[0].id;g.ajaxMode?b.ajax({url:g._data,data:{id:i},tree:g,success:function(a){a&&a.length?g.init(i,!0):(c.addClass("no_child").next("ul").remove(),c.find(".last_ico1").length&&c.find(".last_ico1").addClass("last_ico").removeClass("last_ico1")),e.data("init",!0)}}):(g.init(i,!0),e.data("init",!0))}e&&e.is(":hidden")&&e.show(),c.addClass("open")}else if(c.hasClass("folder")||c.hasClass("item")||c.hasClass("text")||c.hasClass("line")||c.hasClass("ico"))c.hasClass("item")||(c=c.parent()),g.box.find("a.current").removeClass("current"),c.addClass("current"),g.options.onSelect&&g.options.onSelect.call(g,g.data.all[c[0].id]);else if("input"==f.tagName.toLowerCase()){var j,k,l,m=c.closest("a.item").next("ul").find("input"),n=c.parents("ul");if(f.checked){m.attr("checked","checked");for(var j=0;j<n.length;j++)k=n.eq(j),k.find("input").not(":checked").length||k.prev("a.item").find("input").attr("checked","checked")}else m.attr("checked",!1),n.prev("a.item").find("input").attr("checked",!1);return l=g.box.find(":checked"),g.checked=l.length?function(){var a=[];return l.each(function(){a.push(this.value)}),a}():null,g.options.onCheck&&g.options.onCheck.call(g,f.id),!0}return!1})},addClass:function(a,b){a=a||this.box;var c,d,e,f,g,h,i,j,k=a.find("a.item"),l=k.length;for(c=0;l>c;c++)if(g=k.eq(c),b&&0==c&&g.find(".ico").addClass("first_ico"),i=g.closest("li"),g.next("ul").length)for(!i.next().length&&g.find(".ico").addClass("last_ico1"),j=i.attr("level"),d=0;d<i.find("li").length;d++)for(h=i.find("li").eq(d).find(".line"),!i.next().length&&h.eq(j).addClass("last_line"),e=g.find(".last_line"),f=0;f<e.length;f++)h.eq(e.eq(f).index()).addClass("last_line");else!this.ajaxMode&&g.addClass("no_child"),i.next().length||g.find(".ico").addClass("last_ico")},select:function(c,d){function e(){return j.addClass("current"),i.options.onSelect&&i.options.onSelect.call(i,i.data.all[c]),!1}function f(a){0>a||(n=o.eq(a),n.show().siblings("a.item").addClass("open"),f(--a))}if(c){d=d||"id";var g,h,i=this,j=this.box.find("a["+d+'="'+c+'"]').eq(0),k=this.data.all,l=b.key.parent,m=[];if(k[c]){if(!j||!j.length){if(m=b.parents(c,this.data.all,function(a){return 2==a.init}),m.length){for(g=m.length-1;g>=0;g--){for(h=k[m[g]];!h.init;)a("#more_"+h[l]+"_"+h.level).click();a("#"+m[g]).find("i.ico").click()}m=a("#"+m[0]).next()}else m=a("#"+k[c][l]).next();if(j=m.find("a["+d+'="'+c+'"]').eq(0),!j.length){for(;!k[c].init;)m.find("li[level="+k[c].level+"].more a").click();j=m.find("a["+d+'="'+c+'"]').eq(0)}}if(this.box.find("a.current").removeClass("current"),i.selected=c,j.parents("ul").first().is(":visible"))return e();var n,o=j.parents("ul").not(":visible"),p=o.length;f(p-1),e()}}},replaceLink:function(b){if(a.browser("ie6 ie7")){b=b||this.box;var c=b.find("a");c.each(function(){this.href=this.getAttribute("reallink",2),this.removeAttribute("reallink")})}}},b.select=function(c,d){function e(a){var c,d,e="";d=u[a],e='<select name="">',e+=s?'<option value="'+b.rootID+'">根目录</option>':o;for(c in d)v!=d[c][x]&&(e+=h(d[c],a));return e+="</select>"}function f(a){var b,c="";if(w++,a.length)for(b in a)c+=h(q.all[a[b]],w);return w--,c}function g(a){var b="--";for(i=0;a>i;i++)b+="--";return b}function h(a,b){return'<option value="'+(void 0!=a[x]?a[x]:"")+'">'+(s?g(b):"")+a[y]+"</option>"+(s?f(a[z]):"")}function j(){p=e(w),p=a(p),void 0!=r[0]&&(p[0].value=r[0],r[0]=null),c.html(p)}function k(a,c){b.ajax({url:d.data,data:a,success:function(d){if(d&&d.length){if(a&&a.id){var e,f=b.key.parent;for(e=0;e<d.length;e++)d[e][f]=a.id}q=b.format(d,q),u=q.level,c?c():(j(),!s&&n(p))}}})}function l(b,c){var d=q.all[c],e=d[z];e.length&&(b=a(b),d.init=!0,w=d.level,e=a('<select name="">'+o+f(e)+"</select>"),void 0!=r[w+1]&&(e[0].value=r[w+1],r[w+1]=null),b.after(e),n(e))}function m(b){var c=b.value;a(b).nextAll("select").remove(),c!=v&&q.all[c]&&(t&&!q.all[c].init?k({id:c},function(){l(b,c)}):l(b,c))}function n(a){a.change(function(){m(this)}),a.val()&&m(a[0])}d=d||{};var o,p,q="string"==typeof d.data?{}:b.format(d.data),r=[].concat(d.select),s=0==d.level,t="string"==typeof d.data,u=t?[]:q.level,v=void 0!=d.empty?d.empty:"",w=0,x=b.key.id,y=b.key.name,z=b.key.children;if(c&&c.length&&u)return o='<option value="'+v+'">请选择</option>',t?k():j(),s||p&&n(p),p},b});