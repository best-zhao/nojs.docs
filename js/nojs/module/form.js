/*nolure@vip.qq.com|http://nolure.github.io/nojs.docs*/define("nojs/module/form",[],function(require,$,ui){var form=function(a,b,c){a.length&&b&&(this.opt=c=c||{},this.btn=a,this.rules=b,this.form=c.form||a.closest("form"),this.form.length&&(this.item=[],this.showIco=0==c.showIco?!1:!0,this.formSubmit=0==c.formSubmit?!1:!0,this.onSubmit=c.onSubmit,this.onBeforeSubmit=c.onBeforeSubmit,this.checkMode=c.checkMode||"submit",this.init()))};return form.prototype={init:function(a){function b(a){c=k.form.find("[name='"+a+"']"),c.length&&(h=g.replace,h&&(h="function"==typeof h?h.call(c):h,c.data("replace",h)),i=k.type(c),("checkbox"!=i&&"radio"!=i||void 0!==g.isNull)&&(k.item.push(c),"input"==i||"textarea"==i?function(a){if(a.off("keyup.validate").on("keyup.validate",function(){a.data("state",!1)}),k.formSubmit||"input"!=k.type(a)||a.off("keyup.validate").on("keyup.validate",function(a){13==a.keyCode&&k.btn.click()}),"password"===a.attr("type")){var b,c=g.confirmPas,d="rePas"+$.random();c&&c.name&&(b=k.form.find("[name='"+c.name+"']"),a.off("keyup.validate").on("keyup.validate",function(){a.data("state",!1),b.data("state",!1)}),b.off("keyup.validate").on("keyup.validate",function(){b.data("state",!1)}),form.reg[d]=function(b){return a.val()==b?!0:!1},j={isNull:"undefined"!=typeof c.isNull?c.isNull:"请填写确认密码"},j[d]="undefined"!=typeof c.error?c.error:"两次密码输入不一致",b.data("rule",j),b.data("state",!1),k.item.push(b))}}(c):("checkbox"==i||"radio"==i)&&(j={},j.isLength=g.isLength||[],j.isLength[0]=j.isLength[0]||g.isNull,j.isLength[1]=j.isLength[1]||{},j.isLength[1].min="radio"==i?1:j.isLength[1].min||1,g=j),c.data("rule",g),c.data("state",!1)))}var c,d,e,f,g,h,i,j,k=this;this.rules=$.extend(!0,{},a||this.rules),this.item=[];for(d in this.rules){if(g=this.rules[d],f=$.trim(d),f.indexOf(" ")>0)for(f=f.split(" "),e=0;e<f.length;e++)b(f[e]);else b(f);g.replace&&delete g.replace}!a&&this.bind()},bind:function(){var a,b,c,d=this,e=!0;if(this.form.submit(function(){return e?(e=!1,window.setTimeout(function(){e=!0},500),d.submit(d.onSubmit)):!1}),this.formSubmit||this.btn.click(function(){return"form"==d.form[0].tagName.toLowerCase()?d.form.submit():d.submit(d.onSubmit),!1}),this.checkMode&&("keyup"==this.checkMode||"blur"==this.checkMode))for(var f=0;f<d.item.length;f++)a=d.item[f],c=this.type(a),"input"==c||"textarea"==c?("keyup"==this.checkMode&&(this.checkMode="keyup blur"),a.bind(this.checkMode,function(){m=$(this),clearTimeout(b),b=setTimeout(function(){d.check(m)},90)})):("checkbox"==c||"select"==c)&&a.on("change",function(){d.check($(this))})},type:function(a){var b=a[0].tagName.toLowerCase(),c=b;return"input"==b&&("checkbox"==a.attr("type")?c="checkbox":"radio"==a.attr("type")?c="radio":"hidden"==a.attr("type")&&(c="hidden")),c},check:function(a,b,c){if(!a.length)return!0;var d,e,f,g,h=this,i=c||a.data("rule"),j=!1,k="",l=this.type(a),m=form.state,n=form.reg;if(!i)return!0;if("checkbox"==l||"radio"==l)return d=a.filter(":checked").length,e=i.isLength,k=e[0],f=e[1],n.isLength(d,f,a)?(j=!0,this.showIco&&m(a.last(),"ok")):(j=!1,this.showIco&&m(a.last(),"error",k),a.last().focus()),a.data("state",j),j;if(d=a.val(),"undefined"==typeof i.isNull&&("input"==l||"textarea"==l)&&""==d)return a.data("state",!0),!0;if(("input"==l||"textarea"==l)&&1==a.data("state")&&""!=d)return!0;for(var o in i)if(e=i[o],n[o]?("array"==$.type(e)?(e[0]&&(k=e[0]),e[1]&&(f=e[1])):k=e,k="function"==typeof k?k.call(a):k,"remote"==o&&(a.data("tip",k),b&&(f.callback=function(){h.submit(h.onSubmit)})),g="select"==l&&0==d?!1:n[o].call(h,d,f,a),1==g?(j=!0,this.showIco&&m(a,"ok")):0==g?(this.showIco&&m(a,"error",k),b&&a.focus(),j=!1):"pending"==g&&(this.showIco&&m(a,"pending","loading..."),j=!1)):j=!0,0==j)break;return a.data("state",j),j},submit:function(a){var b;if(this.onBeforeSubmit&&!this.onBeforeSubmit())return!1;for(var c=0,d=this.item.length;d>c;c++)if(b=this.item[c],!this.check(b,!0))return!1;return a?a.call(this):void 0},reset:function(){var a=this.form[0];"form"==a.tagName.toLowerCase()&&a.reset(),this.form.find("span.nj_f_tip").remove()}},form.state=function(a,b,c){c=c||"";var d,e=$('<span class="nj_f_tip"><span class="tip_ico"></span><span class="tip_con">'+c+"</span></span>"),f=e.find("span.tip_ico");b="pending"==b?"loading":b,a.data("replace")&&(a=a.data("replace")),d=a.offset(),a.siblings(".nj_f_tip").remove(),a.after(e),new ui.ico(f,{type:b}),e.addClass("nj_f_"+b)},form.reg={isNull:function(a){return""!=a.replace(/\s/g,"")?!0:!1},isEmail:function(a){var b=/^\w+(?:[-+.']\w+)*@\w+(?:[-.]\w+)*\.\w+(?:[-.]\w+)*$/;return b.test(a)?!0:!1},isQQ:function(a){var b=/^\s*[.0-9]{5,10}\s*$/;return b.test(a)?!0:!1},isUrl:function(a){var b=/^(?:http(?:s)?:\/\/)?([\w-]+\.)+[\w-]+(?:\/[\w- .\/\?%&=]*)?$/;return b.test(a)?!0:!1},isMobile:function(a){var b=/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])[0-9]{8}$/;return b.test(a)?!0:!1},isTel:function(a){var b=/^\d{2,5}?[-]?\d{5,8}([-]\d{0,1})?$/;return b.test(a)?!0:!1},isTel400:function(a){var b=/^(400)[-]?\d{3}[-]?\d{4}$/;return b.test(a)?!0:!1},isIdcard:function(a){var b=/^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}(?:\d|[a-zA-Z])$/;return b.test(a)?!0:!1},specialCode:function(a){return/^[\u4e00-\u9fa5\w]*$/.test(a)?!0:!1},isLength:function(a,b){if(b){var c=function(a){for(var b=0,c=0;c<a.length;c++)b+=/[\u4e00-\u9fa5]/.test(a.charAt(c))?2:1;return b},b=b,d="string"==typeof a?c(a):"number"==typeof a?a:0,e=!0;return b.min&&d<b.min&&(e=!1),b.max&&d>b.max&&(e=!1),e}},isNum:function(val,opt){var opt=opt||{},p,test=!isNaN(val);return opt.decimals&&(p=eval("/^-?\\d+(?:\\.\\d{1,"+opt.decimals+"})?$/"),test=p.test(val)),(opt.min||0==opt.min)&&val<opt.min&&(test=!1),(opt.max||0==opt.max)&&val>opt.max&&(test=!1),"int"==opt.type&&-1!=val.indexOf(".")&&(test=!1),val.lastIndexOf(".")==val.length-1&&(test=!1),test},remote:function(a,b,c){var d;return b=b||{},d=b.data=b.data||{},"function"==typeof b.data&&(d=b.data.call(this)||{}),b.name?d[b.name]=a:d[c.attr("name")]=a,$.ajax({url:b.url,type:b.type||"get",data:d,dataType:b.dataType||"json",success:function(a){if(a){c.data("remote",a);var d=c.data("tip");1==a.state||1==a.status?(c.data("state",!0),form.state(c,"ok"),b.callback&&b.callback(),b.callback=null):(c.data("state",!1),c.data("replace")&&(c=c.data("replace")),form.state(c,"error",a.msg||d))}}}),"pending"}},form});