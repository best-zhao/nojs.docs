/*2013/11/19-http://nolure.github.io/nojs.docs*/define("nojs/module/upload",[],function(require,$){function upload(a,b){if(a&&a.length){var c=$.extend({uploader:null,getProgressUrl:null,name:a[0].name||"file",onSelect:null,onSuccess:null,onError:null,limit:10,fileSize:2,fileType:".jpg,.png,.gif",showPreview:!0,auto:!0,dragUp:null,showProgress:!0,upProgress:null,fileDomain:"",dataField:null,formData:{}},upload.config);this.options=c=$.extend(c,b),c.fileSize=1024*1024*(c.fileSize||2),c.multi=c.limit>1,c.dataField=$.extend(c.dataField,{file:"file"}),this.button=a,this.parent=this.button.parent(),this.buttonHTML=a[0].outerHTML,this.fileItem={},this.queue=[],this.state=null,this.count=0,this.tip="function"==typeof c.tip?c.tip:function(a){alert(a)},c.dragUp&&c.dragUp.length&&upload.dragUp(this),this.init()}}var agent=navigator.userAgent.toLowerCase(),browser={0:window.FileReader,1:window.ActiveXObject,3:/msie [67]/.test(agent),4:window.FormData&&window.XMLHttpRequest};return browser["2"]=!browser["0"]&&!browser["1"],upload.config={},upload.formatSize=function(a){return a?(a/=1024,a=a>1024?(a/1024).toFixed(2)+"M":a.toFixed(2)+"K"):null},upload.dragUp=function(a){function b(a){a.stopPropagation(),a.preventDefault(),this.setAttribute("style","border-style:dashed;border-color:red")}function c(){this.setAttribute("style","")}function d(a){a.stopPropagation(),a.preventDefault()}function e(b){b.stopPropagation(),b.preventDefault();var c=b.dataTransfer.files,d={drag:!0};a.push(c,d)}var f=a.options.dragUp;return window.FileReader?(f=f[0],f.addEventListener("dragenter",b,!1),f.addEventListener("dragover",d,!1),f.addEventListener("drop",e,!1),f.addEventListener("dragleave",c,!1),void 0):(f.append("您的浏览器不支持拖拽上传"),void 0)},upload.prototype={init:function(a){var b,c=this,d=this.options;this.button&&0!=a&&this.button.remove(),this.button=$(this.buttonHTML).appendTo(this.parent),d.multi&&!/version.+safari/.test(agent)&&(this.button[0].multiple=!0),this.button.change(function(){var a,e=this.value,f=this.files;if(e){if(c.count>=d.limit)return c.tip("超出数量","warn"),this.value="",void 0;if(c.fileItem[e]&&!f)return c.tip("文件已存在","warn"),this.value="",void 0;if(d.fileType&&(a=e.substring(e.lastIndexOf("."),e.length).toLowerCase(),d.fileType.indexOf(a)<0))return c.tip("文件格式错误","warn"),this.value="",void 0;b={},b.name=e.substring(e.lastIndexOf("\\")+1,e.length),c.push(f,b)}})},push:function(a,b){function c(c){if(!h.fileItem[c]){var d="file"+ +new Date;h.fileItem[c]=b.id=d,h.fileItem[d]={file:c,button:h.button},a&&(h.fileItem[d].files=f),h.queue.push(d),h.count++,h.Events("onSelect",b),h.setProgress(0,d,b.size&&{loaded:0,total:""}),browser["4"]||i.auto||(h.button.css({position:"absolute",top:"-999em"}).removeAttr("id"),h.init(!1)),!browser["2"]&&h.preview(d)}}var d,e,f,g,h=this,i=this.options,j=this.button[0].value;if(b=b||{},a)for(d=a.length,e=0;d>e&&!(h.count>=i.limit);e++)f=a[e],g=f.size,g>i.fileSize||(b.size=upload.formatSize(g),b.name=f.name,c(j.substring(0,j.lastIndexOf("\\")+1)+f.name));else c(j);i.auto&&h.startUpload(),browser["4"]&&this.button.val("")},Events:function(a,b){var c=this,d=b.id,e=c.options[a];"function"==typeof e&&(e=e.call(this,b),"onSelect"==a&&(c.fileItem[d].wrap=e,c.fileItem[d].wrap.find(".cancel").click(function(){return c.cancelUpload(this.id),!1})))},startUpload:function(){if(!this.state&&this.queue.length){if("string"!=typeof this.options.uploader)return this.tip("上传地址错误","warn"),void 0;var a=this.queue.shift();this.fileItem[a]&&(this.id=a,this.uploading(a))}},uploading:function(id){function uploadFile(){xhr.upload.addEventListener("progress",uploadProgress,!1),xhr.addEventListener("load",uploadComplete,!1),xhr.addEventListener("error",uploadFailed,!1),xhr.addEventListener("abort",uploadCanceled,!1),xhr.open("POST",opt.uploader,!0),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");var a=new FormData;a.append(T.button[0].name,_file.files),a.append("uploadID",id);for(var b in opt.formData)a.append(b,opt.formData[b]);xhr.send(a)}function uploadProgress(a){var b,c="";a.lengthComputable&&(b=Math.round(100*a.loaded/a.total),c=b.toString(),T.setProgress(c,null,{loaded:a.loaded,total:a.total}))}function uploadComplete(evt){T.state=!1;var data=eval("("+evt.target.response+")");browser["2"]&&T.preview(data),T.xhr=null,_file.state=null,T.Events("onSuccess",data),T.startUpload()}function uploadFailed(evt){var data=eval("("+evt.target.response+")");T.Events("onError",data)}function uploadCanceled(){}var T=this,opt=this.options,_file=this.fileItem[id];if(this.state=!0,_file.state=!0,browser["4"]){var xhr=this.xhr=new XMLHttpRequest;uploadFile()}else{var name="uploadiframe"+ +new Date,callback="upload"+ +new Date,action=opt.uploader+(opt.uploader.indexOf("?")<0?"?":"&")+"jsoncallback="+callback,formData='<input type="hidden" name="uploadID" value="'+id+'" />';for(var i in opt.formData)formData+='<input type="hidden" name="'+i+'" value="'+opt.formData[i]+'" />';this.form=$('<form target="'+name+'" action="'+action+'" method="post" enctype="multipart/form-data" style="position:absolute;left:-999em">'+formData+"</form>").appendTo(document.body),this.iframe=$('<iframe name="'+name+'" style="display:none"></iframe>').appendTo(document.body),_file.button.appendTo(this.form),window[callback]=function(a){T.id==a.uploadID&&(T.form.remove(),T.iframe.remove(),T.state=!1,_file.state=null,1==a.status?(browser["2"]&&T.preview(a),T.Events("onSuccess",a)):T.Events("onError",a),T.startUpload()),window[callback]=null},T.form.submit(),T.getProgress()}},setProgress:function(a,b){if(this.options.showProgress){var c=this.fileItem[b||this.id],d=this.options.upProgress||(c&&c.wrap?c.wrap.find(".up_progress"):null);a+="%",d&&d.html('<div class="progress"><div class="p" style="width:'+a+'"></div><div class="n">'+a+"</div></div>")}},preview:function(a){function b(a){f.find("img").attr("src",a)}if(this.options.showPreview){var c=this,d=c.fileItem["string"==typeof a?a:this.id],e=this.button[0],f=d.wrap;if(f&&f.length)if(browser["0"]){if(d&&d.files){var g=new FileReader;g.onload=function(a){b(a.target.result)},g.readAsDataURL(d.files)}}else browser["1"]?(this.options.auto||(e=d.button),e.select(),e.blur(),d=document.selection.createRange().text,f.find("img").replaceWith("<div class=\"view\" style=\"filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image',src='"+d+"')\"></div>"),setTimeout(function(){var a=f.find("div.view"),b=a.parent(),c=b.width(),e=b.height(),g=c/e,h=a.width(),i=a.height(),j=h/i;j>g?(h=c,i=h/j):(i=e,h=j*i),a.css({width:h,height:i,filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='"+d+"')\"></div>"}),browser["3"]&&(b.css("position","relative"),a.css({position:"absolute",top:"50%",left:"50%","margin-left":-h/2,"margin-top":-i/2}))},100)):b(this.options.fileDomain+a[this.options.dataField.file])}},getProgress:function(){var a=this.options.getProgressUrl;a&&$.ajax({url:a,data:{ajax:1,uploadID:this.id},type:"get",dataType:"text",cache:!1,success:function(){}})},cancelUpload:function(a){if(a&&this.fileItem[a]){for(var b=this.fileItem[a],c=0;c<this.queue.length;c++)if(this.queue[c]==a){this.queue.splice(c,1);break}delete this.fileItem[b.file],delete b,this.count--,b.wrap&&b.wrap.remove(),b.state&&this.xhr&&this.xhr.abort(),this.state&&this.startUpload()}}},upload});